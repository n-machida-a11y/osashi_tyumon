/**
 * 顧客捺印用注文書生成システム - Backend (GAS)
 * 修正版: AppSheet連携対応（juchuNoパラメータ対応）・本番運用版
 */

const CONFIG = {
  // 本番環境のID等に間違いがないか確認してください
  SS_ID: "1L2DgOm3gfEZMwoe2TDjzBJuq5cHB2SlBlwg6vifg5IE",
  TEMPLATE_SS_ID: "1CaL8QGsNKkpq06jI8QpwHAitCl03ZppsCvC8ILAXj30",
  FOLDER_ID: "1JTTVV4tbtfNW_f_FVxrC9alBFoxT70BC",
  SHEET_MAIN: "受注データ",
  SHEET_DETAIL: "受注明細",
  PDF_COL_NAME: "捺印用PDF",
  ITEMS_PER_PAGE_P1: 15,
  ITEMS_PER_PAGE_PN: 25
};

function doGet(e) {
  // AppSheetからのパラメータ(juchuNo)に対応
  // パラメータがない場合はエラー回避のため空文字またはデフォルト値を設定
  const orderNo = (e.parameter && (e.parameter.juchuNo || e.parameter.orderNo)) || "232922";
  
  const template = HtmlService.createTemplateFromFile('index');
  template.orderNo = orderNo;
  
  return template.evaluate()
    .setTitle("注文書作成システム")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getData(orderNo) {
  try {
    // getActiveSpreadsheet()は使わず、必ずopenByIdを使う
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
    const mainSheet = ss.getSheetByName(CONFIG.SHEET_MAIN);
    const detailSheet = ss.getSheetByName(CONFIG.SHEET_DETAIL);
    if (!mainSheet || !detailSheet) throw new Error("シートが見つかりません。IDやシート名を確認してください。");

    const mainData = mainSheet.getDataRange().getValues();
    const mainHeaders = mainData[0];
    const orderIndex = mainHeaders.indexOf("受注No");
    // 数値型・文字列型の違いを吸収して検索
    const mainRow = mainData.find(row => String(row[orderIndex]) === String(orderNo));
    if (!mainRow) throw new Error(`受注No: ${orderNo} が見つかりません。`);

    const orderInfo = {};
    mainHeaders.forEach((h, i) => { orderInfo[h] = mainRow[i]; });

    const detailData = detailSheet.getDataRange().getValues();
    const detailHeaders = detailData[0];
    const dOrderIndex = detailHeaders.indexOf("受注No");
    
    // 0のデータはあらかじめ除外
    const items = detailData.slice(1)
      .filter(row => {
        if (String(row[dOrderIndex]) !== String(orderNo)) return false;
        const q = Number(row[detailHeaders.indexOf("数量")]) || 0;
        const p = Number(row[detailHeaders.indexOf("単価")]) || 0;
        return q > 0 && p > 0;
      })
      .map(row => {
        const item = {};
        detailHeaders.forEach((h, i) => { item[h] = row[i]; });
        return item;
      });

    return { success: true, orderInfo, items };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function generatePDF(orderData, selectedItems, totals) {
  try {
    const templateFile = DriveApp.getFileById(CONFIG.TEMPLATE_SS_ID);
    const folder = DriveApp.getFolderById(CONFIG.FOLDER_ID);
    
    const todayStr = Utilities.formatDate(new Date(), "JST", "yyyyMMdd");
    const fileName = `${orderNoClean(orderData["受注No"])}_${orderData["得意先名１"]}_${todayStr}_${totals.totalWithTax}円`;
    
    const newSSFile = templateFile.makeCopy("TEMP_" + Utilities.getUuid(), folder);
    // ここもopenByIdを使用
    const newSS = SpreadsheetApp.openById(newSSFile.getId());
    
    const templateSheet = newSS.getSheets()[0];
    templateSheet.setName("TEMPLATE_ORIGIN");

    let amountCol = 0;
    const headerFinder = templateSheet.createTextFinder("金額").findNext(); 
    if (headerFinder) {
        amountCol = headerFinder.getColumn();
    }
    
    const pages = [];
    let currentIdx = 0;
    while (currentIdx < selectedItems.length || (pages.length === 0)) {
      const limit = (pages.length === 0) ? CONFIG.ITEMS_PER_PAGE_P1 : CONFIG.ITEMS_PER_PAGE_PN;
      pages.push(selectedItems.slice(currentIdx, currentIdx + limit));
      currentIdx += limit;
      if (currentIdx >= selectedItems.length && pages.length > 0) break;
    }

    const totalPages = pages.length;

    pages.forEach((pageItems, index) => {
      const isFirst = (index === 0);
      const isLast = (index === totalPages - 1);
      
      const sheet = templateSheet.copyTo(newSS);
      sheet.setName(`P${index + 1}`);

      const replacements = {
        "％受注日％": isFirst ? Utilities.formatDate(new Date(), "JST", "yyyy年MM月dd日") : "",
        "％見積番号％": isFirst ? (orderData["受注No"] || "") : "",
        "％得意先住所１％": isFirst ? (orderData["得意先住所１"] || "") : "",
        "％得意先名１％": isFirst ? (orderData["得意先名１"] || "") : "",
        "％直送先名１％": isFirst ? (orderData["直送先名１"] || "") : "",
        "%得意先住所2%": isFirst ? (orderData["得意先住所１"] || "") : "",
        "%得意先名2%": isFirst ? (orderData["得意先名１"] || "") : "",
        "%直送先名2%": isFirst ? (orderData["直送先名１"] || "") : "",
        "%納期%": isFirst ? (orderData["納入期日"] || "") : "",
        "%締日%": isFirst ? (orderData["締日"] || "") : "",
        "%支払日%": isFirst ? (orderData["支払日"] || "") : "",
        "%支払方法%": isFirst ? (orderData["支払方法"] || "") : ""
      };

      Object.keys(replacements).forEach(k => {
        sheet.createTextFinder(k).replaceAllWith(replacements[k]);
      });

      sheet.getRange(1, 6).setValue(`${index + 1} / ${totalPages} ページ`);

      if (!isFirst) {
        let headerFinder = sheet.createTextFinder("品名").findNext();
        if (!headerFinder) headerFinder = sheet.createTextFinder("商品名").findNext();

        if (headerFinder) {
          const headerRow = headerFinder.getRow();
          if (headerRow > 3) {
            const numRowsToDelete = headerRow - 3;
            if (numRowsToDelete > 0) {
              const rangeToClear = sheet.getRange(2, 1, numRowsToDelete, sheet.getLastColumn());
              rangeToClear.clearContent();
              rangeToClear.setBorder(false, false, false, false, false, false);
              try { sheet.deleteRows(2, numRowsToDelete); } catch(e) {}
            }
          }
        }
        
        const clearLabels = ["支払", "締日", "当月", "翌月", "従来通り", "振込", "税抜合計", "消費税", "税込合計", "納入", "場所", "条件", "期日", "着", "御中", "様", "印"];
        clearLabels.forEach(lbl => { sheet.createTextFinder(lbl).replaceAllWith(""); });
      }

      if (isFirst) {
        setNumeric(sheet, "％税抜合計％", "税抜合計", totals.subtotal);
        setNumeric(sheet, "％消費税％", "消費税", totals.tax);
        setNumeric(sheet, "％税込合計％", "税込合計", totals.totalWithTax);
      } else {
        sheet.createTextFinder("％税抜合計％").replaceAllWith("");
        sheet.createTextFinder("％消費税％").replaceAllWith("");
        sheet.createTextFinder("％税込合計％").replaceAllWith("");
      }

      const subFinder = sheet.createTextFinder("小計").findNext();
      if (subFinder) {
         const row = subFinder.getRow();
         let targetCell = null;

         if (amountCol > 0) {
             targetCell = sheet.getRange(row, amountCol);
         } else {
             const checkRange = sheet.getRange(row, subFinder.getColumn() + 1, 1, 10);
             const values = checkRange.getValues()[0];
             for (let i = 0; i < values.length; i++) {
                 if (values[i] !== "") {
                     targetCell = checkRange.getCell(1, i + 1);
                     break;
                 }
             }
         }

         if (targetCell) {
             if (!isLast) {
                 sheet.createTextFinder("％税込合計％").replaceAllWith("次頁に続く");
                 targetCell.setNumberFormat("@"); 
                 targetCell.setValue("(( 次頁に続く ))").setHorizontalAlignment("right");
             } else {
                 targetCell.setValue(totals.subtotal).setNumberFormat("#,##0");
             }
         }
      }

      const names = sheet.createTextFinder("％商品名％").findAll();
      names.sort((a, b) => a.getRow() - b.getRow());

      names.forEach((range, i) => {
        const rowRange = sheet.getRange(range.getRow(), 1, 1, sheet.getLastColumn());
        if (i < pageItems.length) {
          const item = pageItems[i];
          range.setValue(item["商品名"] || "");
          replaceVal(rowRange, "％数量％", Number(item["数量"]) || 0);
          replaceVal(rowRange, "％単価％", Number(item["単価"]) || 0);
          replaceVal(rowRange, "％金額％", (Number(item["数量"]) * Number(item["単価"])) || 0);
        } else {
          range.setValue("");
          ["％数量％", "％単価％", "％金額％"].forEach(p => {
             rowRange.createTextFinder(p).replaceAllWith("");
          });
        }
      });
    });

    newSS.deleteSheet(templateSheet);

    SpreadsheetApp.flush();
    const pdfBlob = newSSFile.getAs('application/pdf');
    const pdfFile = folder.createFile(pdfBlob);
    pdfFile.setName(fileName + ".pdf");
    
    const mainSS = SpreadsheetApp.openById(CONFIG.SS_ID);
    const mainSheet = mainSS.getSheetByName(CONFIG.SHEET_MAIN);
    const data = mainSheet.getDataRange().getValues();
    const headers = data[0];
    const orderIndex = headers.indexOf("受注No");
    let pdfIdx = headers.indexOf(CONFIG.PDF_COL_NAME);
    if (pdfIdx === -1) {
      pdfIdx = headers.length;
      mainSheet.getRange(1, pdfIdx + 1).setValue(CONFIG.PDF_COL_NAME);
    }
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][orderIndex]) === String(orderData["受注No"])) {
        mainSheet.getRange(i + 1, pdfIdx + 1).setValue(pdfFile.getUrl());
        break;
      }
    }

    newSSFile.setTrashed(true);
    return { success: true, pdfUrl: pdfFile.getUrl() };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function orderNoClean(no) { return String(no).replace(/[^0-9A-Z-]/gi, ''); }

function replaceVal(range, p, v) {
  const t = range.createTextFinder(p).findNext();
  if (t) { t.setValue(v); t.setNumberFormat("#,##0"); }
}

function setNumeric(sheet, p, l, v) {
  let t = sheet.createTextFinder(p).findNext();
  if (t) {
    t.setValue(v);
    t.setNumberFormat("#,##0");
    return;
  }
  const lbl = sheet.createTextFinder(l).findNext();
  if (lbl) {
    const r = lbl.getRow();
    const c = lbl.getColumn();
    const checkRange = sheet.getRange(r, c + 1, 1, 5);
    const values = checkRange.getValues()[0];
    for (let i = 0; i < values.length; i++) {
      if (values[i] === "" || values[i] === 0 || values[i] === "0" || typeof values[i] === 'number') {
        const targetCell = checkRange.getCell(1, i + 1);
        targetCell.setValue(v);
        targetCell.setNumberFormat("#,##0");
        return;
      }
    }
    sheet.getRange(r, c + 2).setValue(v).setNumberFormat("#,##0");
  }
}
